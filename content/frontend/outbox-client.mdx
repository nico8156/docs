---
title: "Outbox client"
---

---

# Outbox Client â€” RÃ©silience cÃ´tÃ© mobile

## ğŸ¯ ProblÃ¨me

Dans un environnement mobile :

* le rÃ©seau est instable
* les connexions WebSocket peuvent tomber
* les requÃªtes HTTP peuvent Ã©chouer
* lâ€™utilisateur peut passer offline
* lâ€™application peut Ãªtre mise en background

Un simple `POST` immÃ©diat nâ€™est pas suffisant.

---

## ğŸ§  DÃ©cision

ImplÃ©menter une **Outbox cÃ´tÃ© client**.

Chaque action utilisateur est :

1. TransformÃ©e en commande sÃ©rialisable
2. PersistÃ©e localement
3. ExÃ©cutÃ©e de maniÃ¨re asynchrone
4. RetentÃ©e automatiquement si Ã©chec

---

## ğŸ—ï¸ ImplÃ©mentation

### 1. Enqueue

Lorsquâ€™un utilisateur clique sur "Like" :

* crÃ©ation dâ€™une commande `Like.Set`
* ajout dâ€™un `commandId`
* persist dans lâ€™Outbox locale
* mise Ã  jour optimiste du state Redux

---

### 2. Dispatcher

Un orchestrateur :

* traite les commandes en file
* applique un backoff exponentiel (cap 60s + jitter)
* suspend en background
* reprend en foreground ou reconnexion rÃ©seau

---

### 3. Idempotence

Chaque commande contient :

* `commandId`
* Ã©ventuellement `draftId`

Le backend peut ainsi :

* ignorer les doublons
* traiter les retries sans effet secondaire

---

### 4. Squash intelligent

Les commandes `Like.Set` successives sont fusionnÃ©es :

```
Like(true)
Like(false)
Like(true)
```

devient :

```
Like(true)
```

Ce mÃ©canisme Ã©vite :

* surcharge rÃ©seau
* conflits inutiles
* pollution du backend

---

## ğŸ”„ Synchronisation avec le serveur

AprÃ¨s traitement cÃ´tÃ© backend :

1. Projection mise Ã  jour
2. WebSocket push vers le client
3. RÃ©conciliation avec le state local
4. Suppression de la commande de lâ€™Outbox

---

## ğŸ“Š Vue simplifiÃ©e

```mermaid
sequenceDiagram
  participant User
  participant UI
  participant Outbox
  participant API
  participant Backend
  participant WS

  User->>UI: Click Like
  UI->>Outbox: Enqueue command
  UI->>UI: Optimistic update
  Outbox->>API: POST
  API->>Backend: Process command
  Backend->>WS: Push update
  WS->>UI: ACK + reconcile
```

---

## ğŸ”’ Garanties obtenues

* ExpÃ©rience fluide mÃªme offline
* Aucune perte dâ€™action utilisateur
* Retry automatique
* CohÃ©rence Ã©ventuelle maÃ®trisÃ©e
* RÃ©silience aux crashs app

---

## âš–ï¸ Trade-offs assumÃ©s

* ComplexitÃ© accrue cÃ´tÃ© client
* Gestion fine du cycle de vie (background/foreground)
* NÃ©cessitÃ© dâ€™un protocole clair avec le backend

---

## ğŸ RÃ©sultat

Un client mobile :

* robuste
* rÃ©silient
* orientÃ© production
* compatible avec un backend distribuÃ©

---
