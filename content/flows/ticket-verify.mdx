---
title: "Ticket verification"
---

---

# Ticket Verification â€” IntÃ©gration CLI + Backend

## ğŸ¯ ProblÃ¨me

La vÃ©rification dâ€™un ticket nÃ©cessite :

* OCR externe
* parsing texte
* validation mÃ©tier
* gestion dâ€™erreurs imprÃ©visibles

PlutÃ´t que dâ€™intÃ©grer une librairie native instable dans la JVM,
le choix a Ã©tÃ© fait dâ€™isoler le traitement OCR dans un **exÃ©cutable CLI dÃ©diÃ©**.

---

## ğŸ§  DÃ©cision

Architecture retenue :

* CLI isolÃ© (stdout JSON only)
* Spring Boot appelle la CLI via `ProcessBuilder`
* Communication via stdin / stdout
* Timeout strict
* Parsing JSON avec Jackson
* Exit codes explicites

Cette sÃ©paration permet :

* isolation des dÃ©pendances OCR
* meilleure testabilitÃ©
* meilleure stabilitÃ©
* gestion claire des erreurs

---

## ğŸ—ï¸ ImplÃ©mentation

### 1. CÃ´tÃ© CLI

Contraintes imposÃ©es :

* stdout contient uniquement du JSON valide
* stderr rÃ©servÃ© aux logs
* exit code â‰  0 en cas dâ€™erreur
* validation stricte des inputs

Exemple de sortie :

```json
{
  "status": "VALID",
  "coffeeName": "Fragments Coffee",
  "amount": 4.50,
  "timestamp": "2026-01-21T10:15:00Z"
}
```

---

### 2. CÃ´tÃ© Spring Boot

Flow :

1. Construction du `ProcessBuilder`
2. Envoi de lâ€™OCR brut via stdin UTF-8
3. Lecture stdout
4. Lecture stderr (logs internes)
5. Timeout configurable
6. VÃ©rification exit code
7. Parsing JSON avec Jackson

En cas de :

* timeout â†’ exception mÃ©tier
* exit code â‰  0 â†’ erreur contrÃ´lÃ©e
* JSON invalide â†’ exception explicite

---

## ğŸ”„ IntÃ©gration dans CQRS

1. Command `Ticket.Verify`
2. Handler appelle le wrapper CLI
3. RÃ©sultat persistant
4. Event Outbox gÃ©nÃ©rÃ©
5. Projection mise Ã  jour
6. WebSocket push vers le client

---

## ğŸ“Š Vue simplifiÃ©e

```mermaid
sequenceDiagram
  participant RN
  participant API
  participant Handler
  participant CLI
  participant Outbox
  participant Kafka
  participant Projection
  participant WS

  RN->>API: Ticket.Verify
  API->>Handler: Execute
  Handler->>CLI: ProcessBuilder
  CLI-->>Handler: JSON result
  Handler->>Outbox: Persist event
  Outbox->>Kafka: Publish
  Kafka->>Projection: Update read
  Projection->>WS: Push update
```

---

## ğŸ”’ Garanties obtenues

* Isolation du moteur OCR
* Timeout maÃ®trisÃ©
* Gestion dâ€™erreurs explicite
* Pas de blocage JVM
* IntÃ©gration testable en TDD
* Contrat clair entre composants

---

## âš–ï¸ Trade-offs assumÃ©s

* CoÃ»t dâ€™un process externe
* ComplexitÃ© supplÃ©mentaire
* Besoin de supervision
* Gestion fine des flux stdout/stderr

---

## ğŸ RÃ©sultat

Un systÃ¨me :

* robuste
* isolÃ©
* testable
* maÃ®trisÃ©
* prÃªt pour la production

---
